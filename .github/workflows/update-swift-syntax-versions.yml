name: Update Swift Syntax Versions

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  check-versions:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check for new swift-syntax releases
      id: check-releases
      run: |
        # Fetch releases from GitHub API
        RELEASES=$(curl -s "https://api.github.com/repos/swiftlang/swift-syntax/releases" | jq -r '.[].tag_name')
        
        # Filter out prereleases and non-standard versions, only keep versions >= 509.0.0
        OFFICIAL_RELEASES=$(echo "$RELEASES" | grep -E '^[0-9]{3}\.[0-9]+\.[0-9]+$' | awk -F. '$1 >= 509 { print }' | sort -V)
        
        # Read current versions from script
        CURRENT_VERSIONS=$(grep -A 20 "ALL_VERSIONS=(" swift-macro-compatibility-check.sh | grep -o '"[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*"' | tr -d '"' | sort -V)
        
        # Find new versions (only versions >= 509.0.0)
        NEW_VERSIONS=""
        for version in $OFFICIAL_RELEASES; do
          if ! echo "$CURRENT_VERSIONS" | grep -q "^$version$"; then
            # Double-check version is >= 509.0.0
            if echo "$version" | awk -F. '$1 >= 509 { exit 0 } { exit 1 }'; then
              NEW_VERSIONS="$NEW_VERSIONS $version"
            fi
          fi
        done
        
        if [ -n "$NEW_VERSIONS" ]; then
          echo "new_versions_found=true" >> $GITHUB_OUTPUT
          echo "versions=$NEW_VERSIONS" >> $GITHUB_OUTPUT
          echo "New versions found: $NEW_VERSIONS"
        else
          echo "new_versions_found=false" >> $GITHUB_OUTPUT
          echo "No new versions found"
        fi
        
    - name: Update script with new versions
      if: steps.check-releases.outputs.new_versions_found == 'true'
      run: |
        NEW_VERSIONS="${{ steps.check-releases.outputs.versions }}"
        
        # Create backup
        cp swift-macro-compatibility-check.sh swift-macro-compatibility-check.sh.bak
        
        # Read current ALL_VERSIONS array
        CURRENT_VERSIONS=$(grep -A 20 "ALL_VERSIONS=(" swift-macro-compatibility-check.sh | grep -o '"[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*"' | tr -d '"')
        
        # Combine and sort all versions
        ALL_VERSIONS=$(echo -e "$CURRENT_VERSIONS\n$NEW_VERSIONS" | sort -V | uniq)
        
        # Build new array content
        NEW_ARRAY="ALL_VERSIONS=(\n"
        for version in $ALL_VERSIONS; do
          NEW_ARRAY="$NEW_ARRAY  \"$version\"\n"
        done
        NEW_ARRAY="$NEW_ARRAY)"
        
        # Replace the ALL_VERSIONS array in the script
        awk -v version_list="$(echo "$ALL_VERSIONS" | tr '\n' ' ')" '
        /^ALL_VERSIONS=\(/ { 
          print "ALL_VERSIONS=("
          while (getline > 0 && !/^\)/) { }
          split(version_list, version_array, " ")
          for (i in version_array) {
            if (version_array[i] != "") {
              print "  \"" version_array[i] "\""
            }
          }
          print ")"
          next
        }
        { print }
        ' swift-macro-compatibility-check.sh.bak > swift-macro-compatibility-check.sh
        
        # Update MAJOR_VERSIONS if needed (major versions are x.0.0)
        MAJOR_VERSIONS=$(echo "$ALL_VERSIONS" | grep '\.0\.0$')
        if [ -n "$MAJOR_VERSIONS" ]; then
          awk -v version_list="$(echo "$MAJOR_VERSIONS" | tr '\n' ' ')" '
          /^MAJOR_VERSIONS=\(/ { 
            print "MAJOR_VERSIONS=("
            while (getline > 0 && !/^\)/) { }
            split(version_list, version_array, " ")
            for (i in version_array) {
              if (version_array[i] != "") {
                print "  \"" version_array[i] "\""
              }
            }
            print ")"
            next
          }
          { print }
          ' swift-macro-compatibility-check.sh > swift-macro-compatibility-check.sh.tmp
          mv swift-macro-compatibility-check.sh.tmp swift-macro-compatibility-check.sh
        fi
        
        rm swift-macro-compatibility-check.sh.bak
        
    - name: Create Pull Request
      if: steps.check-releases.outputs.new_versions_found == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "Add new swift-syntax versions: ${{ steps.check-releases.outputs.versions }}"
        title: "Update swift-syntax compatibility versions"
        body: |
          ## New swift-syntax versions detected
          
          This PR adds the following new swift-syntax versions:
          ${{ steps.check-releases.outputs.versions }}
          
          ### Changes made:
          - Updated `ALL_VERSIONS` array in `swift-macro-compatibility-check.sh`
          - Updated `MAJOR_VERSIONS` array if any new major versions (x.0.0) were added
          
          This PR was automatically created by the `update-swift-syntax-versions` workflow.
        branch: update-swift-syntax-versions
        delete-branch: true